% Cylinder
clear;
p=2;
q=2;
r=2;

U = [0 0 0 1 1 2 2 3 3 4 4 4];          
V = [0 0 0 0.5 1 1 1];  
W = [0 0 0 1 1 1];

CP(:,:,1,1) = [
1.00000 1.00000 0.00000 -1.00000 -1.00000 -1.00000 0.00000 1.00000 1.00000
1.33333 1.33333 0.00000 -1.33333 -1.33333 -1.33333 0.00000 1.33333 1.33333
1.66667 1.66667 0.00000 -1.66667 -1.66667 -1.66667 0.00000 1.66667 1.66667
2.00000 2.00000 0.00000 -2.00000 -2.00000 -2.00000 0.00000 2.00000 2.00000 ]';
CP(:,:,2,1) = [
1.00000 1.00000 0.00000 -1.00000 -1.00000 -1.00000 0.00000 1.00000 1.00000
1.33333 1.33333 0.00000 -1.33333 -1.33333 -1.33333 0.00000 1.33333 1.33333
1.66667 1.66667 0.00000 -1.66667 -1.66667 -1.66667 0.00000 1.66667 1.66667
2.00000 2.00000 0.00000 -2.00000 -2.00000 -2.00000 0.00000 2.00000 2.00000 ]';
CP(:,:,3,1) = [
1.00000 1.00000 0.00000 -1.00000 -1.00000 -1.00000 0.00000 1.00000 1.00000
1.33333 1.33333 0.00000 -1.33333 -1.33333 -1.33333 0.00000 1.33333 1.33333
1.66667 1.66667 0.00000 -1.66667 -1.66667 -1.66667 0.00000 1.66667 1.66667
2.00000 2.00000 0.00000 -2.00000 -2.00000 -2.00000 0.00000 2.00000 2.00000 ]';

CP(:,:,1,2) = [
0.00000 1.00000 1.00000 1.00000 0.00000 -1.00000 -1.00000 -1.00000 0.00000
0.00000 1.33333 1.33333 1.33333 0.00000 -1.33333 -1.33333 -1.33333 0.00000
0.00000 1.66667 1.66667 1.66667 0.00000 -1.66667 -1.66667 -1.66667 0.00000
0.00000 2.00000 2.00000 2.00000 0.00000 -2.00000 -2.00000 -2.00000 0.00000 ]';
CP(:,:,2,2) = [
0.00000 1.00000 1.00000 1.00000 0.00000 -1.00000 -1.00000 -1.00000 0.00000
0.00000 1.33333 1.33333 1.33333 0.00000 -1.33333 -1.33333 -1.33333 0.00000
0.00000 1.66667 1.66667 1.66667 0.00000 -1.66667 -1.66667 -1.66667 0.00000
0.00000 2.00000 2.00000 2.00000 0.00000 -2.00000 -2.00000 -2.00000 0.00000 ]';
CP(:,:,3,2) = [
0.00000 1.00000 1.00000 1.00000 0.00000 -1.00000 -1.00000 -1.00000 0.00000
0.00000 1.33333 1.33333 1.33333 0.00000 -1.33333 -1.33333 -1.33333 0.00000
0.00000 1.66667 1.66667 1.66667 0.00000 -1.66667 -1.66667 -1.66667 0.00000
0.00000 2.00000 2.00000 2.00000 0.00000 -2.00000 -2.00000 -2.00000 0.00000 ]';

CP(:,:,1,3) = -[
0.00000 0.00000 0.00000 0.00000 0.00000 0.00000 0.00000 0.00000 0.00000
0.00000 0.00000 0.00000 0.00000 0.00000 0.00000 0.00000 0.00000 0.00000
0.00000 0.00000 0.00000 0.00000 0.00000 0.00000 0.00000 0.00000 0.00000
0.00000 0.00000 0.00000 0.00000 0.00000 0.00000 0.00000 0.00000 0.00000 ]';
CP(:,:,2,3) = -[
2.50000 2.50000 2.50000 2.50000 2.50000 2.50000 2.50000 2.50000 2.50000
2.50000 2.50000 2.50000 2.50000 2.50000 2.50000 2.50000 2.50000 2.50000
2.50000 2.50000 2.50000 2.50000 2.50000 2.50000 2.50000 2.50000 2.50000
2.50000 2.50000 2.50000 2.50000 2.50000 2.50000 2.50000 2.50000 2.50000 ]';
CP(:,:,3,3) = -[
5.00000 5.00000 5.00000 5.00000 5.00000 5.00000 5.00000 5.00000 5.00000
5.00000 5.00000 5.00000 5.00000 5.00000 5.00000 5.00000 5.00000 5.00000
5.00000 5.00000 5.00000 5.00000 5.00000 5.00000 5.00000 5.00000 5.00000
5.00000 5.00000 5.00000 5.00000 5.00000 5.00000 5.00000 5.00000 5.00000 ]';

CP(:,:,1,4) = [
1.00000 0.70711 1.00000 0.70711 1.00000 0.70711 1.00000 0.70711 1.00000
1.00000 0.70711 1.00000 0.70711 1.00000 0.70711 1.00000 0.70711 1.00000
1.00000 0.70711 1.00000 0.70711 1.00000 0.70711 1.00000 0.70711 1.00000
1.00000 0.70711 1.00000 0.70711 1.00000 0.70711 1.00000 0.70711 1.00000 ]';
CP(:,:,2,4) = [
1.00000 0.70711 1.00000 0.70711 1.00000 0.70711 1.00000 0.70711 1.00000
1.00000 0.70711 1.00000 0.70711 1.00000 0.70711 1.00000 0.70711 1.00000
1.00000 0.70711 1.00000 0.70711 1.00000 0.70711 1.00000 0.70711 1.00000
1.00000 0.70711 1.00000 0.70711 1.00000 0.70711 1.00000 0.70711 1.00000 ]';
CP(:,:,3,4) = [
1.00000 0.70711 1.00000 0.70711 1.00000 0.70711 1.00000 0.70711 1.00000
1.00000 0.70711 1.00000 0.70711 1.00000 0.70711 1.00000 0.70711 1.00000
1.00000 0.70711 1.00000 0.70711 1.00000 0.70711 1.00000 0.70711 1.00000
1.00000 0.70711 1.00000 0.70711 1.00000 0.70711 1.00000 0.70711 1.00000 ]';

% mesh 4
for i=1:3; R1(i)=i/4; R2(i)=i/8; end
% Ru = [R1 R1+1 R1+2 R1+3];
% Rv = [R2 R2+0.5];
% Rw = R1;
% [CP,U,V,W] = knot_refine_solid(p,q,r,U,V,W,CP,Ru,Rv,Rw);

% material
E = 7.5e7;
nue = 0.25;
% Gauss Points
ngauss=[4 4 4];

% closed faces
closed = [1 0 0];
ms = master_slaves(closed,CP);

% fixed supports
rb =[];
us=[0 0]; vs=[0 0]; ws=[1 1];  dirs=1;
rb = supports(rb,us,vs,ws,dirs,CP);
us=[0 0]; vs=[0 1]; ws=[1 1];  dirs=2;
rb = supports(rb,us,vs,ws,dirs,CP);
us=[0 1]; vs=[0 1]; ws=[1 1];  dirs=3;
rb = supports(rb,us,vs,ws,dirs,CP);

% load vector
f = 1e5;  fl=[];
ub=[0 4]; vb=0; wb=[0 1];  dirf=7;   proj=0;
fl = load_area(fl,ub,vb,wb,p,q,r,U,V,W,CP,ngauss,f,dirf,proj);

% plotNURBS_solid(p,q,r,U,V,W,CP)
% compute displacement vector d and load vector including supports fs
% [d,fs] = solve(p,U,q,V,r,W,CP,E,nue,ngauss,fl,rb);
[d,fs] = solve_closed(p,U,q,V,r,W,CP,E,nue,ngauss,fl,rb,ms);
CPd = CPresult(CP,d);

% visualize
% plot2in1(p,q,r,U,V,W,CP,CPd,rb,fl)
plot_displacement(p,q,r,U,V,W,CP,CPd,rb,fl,4)